// === Ambil access token ===
function getAccessToken() {
  const tokenUrl = 'https://oauth2.googleapis.com/token';
  const options = {
    method: 'post',
    payload: {
      client_id: CLIENT_ID,
      client_secret: CLIENT_SECRET,
      refresh_token: REFRESH_TOKEN,
      grant_type: 'refresh_token'
    },
    muteHttpExceptions: true
  };
  const response = UrlFetchApp.fetch(tokenUrl, options);
  const result = JSON.parse(response.getContentText());
  if (result.error) throw new Error(result.error_description);
  return result.access_token;
}

// === Posting ke Blogger sebagai draft ===
function postToBlogger(title, content) {
  const accessToken = getAccessToken();
  const url = `https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/`;
  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify({
      title,
      content,
      isDraft: true // Draft mode
    }),
    headers: { Authorization: `Bearer ${accessToken}` },
    muteHttpExceptions: true
  };
  const response = UrlFetchApp.fetch(url, options);
  const result = JSON.parse(response.getContentText());
  if (result.error) throw new Error(result.error.message);
  return result;
}

// === Logging ===
function getLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(LOG_SHEET_NAME);
  if (!sheet) sheet = ss.insertSheet(LOG_SHEET_NAME).appendRow(['Title', 'Link', 'Posted At']);
  return sheet;
}

function isAlreadyPosted(link) {
  const sheet = getLogSheet();
  if (sheet.getLastRow() < 2) return false;
  const links = sheet.getRange(2, 2, sheet.getLastRow() - 1, 1).getValues().flat();
  return links.includes(link);
}

function storePostedLink(title, link) {
  getLogSheet().appendRow([title, link, new Date()]);
}

// === Generator artikel panjang ===
function generateSEOArticle(title, description, imageUrl) {
  // Artikel SEO friendly minimal 500 kata
  let article = `
    <p><img src="${imageUrl}" alt="${title}" style="max-width:100%;border-radius:10px;margin-bottom:15px;"></p>
    <h2>${title}</h2>
    <p>${description || ''}</p>
    <p>${title} menjadi salah satu topik yang tengah ramai diperbincangkan masyarakat. Fenomena ini tidak sekadar sebuah berita singkat, melainkan sebuah cerita yang mencerminkan dinamika sosial, politik, maupun budaya yang ada di sekitar kita. Untuk memahami lebih dalam, mari kita telusuri bagaimana isu ini berkembang, apa saja dampaknya, dan mengapa hal tersebut begitu relevan bagi kehidupan kita sehari-hari.</p>
    <p>Dari sudut pandang historis, peristiwa ini mengingatkan kita pada berbagai momen serupa yang pernah terjadi sebelumnya. Banyak pihak yang mencoba menarik benang merah antara kondisi saat ini dengan pengalaman di masa lalu. Perbandingan semacam ini membantu kita untuk memahami bahwa perjalanan bangsa dan masyarakat selalu penuh dengan lika-liku, pasang surut, serta tantangan yang membutuhkan kebersamaan untuk menghadapinya.</p>
    <p>Secara emosional, ${title} menimbulkan reaksi yang beragam di tengah publik. Ada yang merespons dengan optimisme dan harapan, namun tak sedikit pula yang menyikapinya dengan kecemasan. Perbedaan reaksi ini mencerminkan betapa pluralnya masyarakat kita, dengan berbagai latar belakang, kepentingan, serta cara pandang yang beragam. Namun di balik itu semua, terdapat kesadaran bahwa peristiwa ini membawa pesan penting yang patut direnungkan bersama.</p>
    <p>Lebih jauh, jika ditinjau dari perspektif sosial, ${title} menghadirkan dampak yang cukup signifikan. Banyak kalangan yang terinspirasi untuk bergerak, bersuara, bahkan terlibat secara aktif dalam berbagai kegiatan positif. Hal ini menunjukkan bahwa berita atau peristiwa bukan hanya sekadar informasi, melainkan juga pemantik semangat perubahan. Dengan cara ini, masyarakat belajar bahwa setiap isu memiliki potensi untuk membentuk arah masa depan.</p>
    <p>Tak hanya itu, aspek ekonomi pun ikut terpengaruh. Ketika publik memberikan perhatian besar pada ${title}, muncul dinamika baru di berbagai sektor yang terkait. Media, pelaku usaha, hingga komunitas lokal merespons dengan caranya masing-masing. Beberapa memanfaatkan momentum ini sebagai peluang, sementara yang lain lebih memilih untuk berhati-hati. Semua ini menggambarkan bagaimana sebuah isu dapat menembus berbagai lapisan kehidupan kita.</p>
    <p>Dari perspektif pribadi, kita pun bisa belajar banyak. ${title} seolah menjadi cermin bagi diri kita masing-masing untuk merenungkan nilai, harapan, dan komitmen yang kita pegang. Apakah kita akan memilih untuk berpangku tangan, ataukah kita justru termotivasi untuk melakukan perubahan? Pertanyaan-pertanyaan ini menjadi penting agar berita tidak hanya berhenti sebagai konsumsi pasif, melainkan juga membangkitkan kesadaran aktif.</p>
    <p>Pada akhirnya, ${title} lebih dari sekadar sebuah peristiwa. Ia adalah cerita kolektif yang menuntun kita pada pemahaman lebih dalam tentang siapa kita, bagaimana kita menyikapi tantangan, serta ke mana kita ingin melangkah. Dengan menggali makna dan pelajaran dari isu ini, kita bisa memperkuat fondasi kehidupan bermasyarakat yang lebih sehat, adil, dan penuh harapan.</p>
    <p>Demikianlah ulasan mendalam mengenai ${title}. Semoga artikel ini tidak hanya memberikan informasi, tetapi juga mampu menginspirasi kita semua untuk terus belajar, bertumbuh, dan berkontribusi dalam setiap dinamika yang terjadi di sekitar kita.</p>
  `;

  return article;
}

// === MAIN FUNCTION ===
function autoPostFromMultiRSS() {
  for (const rssUrl of RSS_FEED_URLS) {
    try {
      const xml = UrlFetchApp.fetch(rssUrl).getContentText();
      const doc = XmlService.parse(xml);
      const root = doc.getRootElement();
      let items;

      // Handle Atom vs RSS 2.0
      if (root.getName() === 'feed') {
        items = root.getChildren('entry');
      } else if (root.getName() === 'rss') {
        const channel = root.getChild('channel');
        if (channel) {
          items = channel.getChildren('item');
        } else {
          Logger.log(`❌ RSS channel not found for ${rssUrl}`);
          continue;
        }
      } else {
        Logger.log(`❌ Unsupported RSS feed type for ${rssUrl}: ${root.getName()}`);
        continue;
      }

      for (const item of items) {
        let title, link, description, imageUrl;

        if (root.getName() === 'feed') { // Atom
          title = item.getChildText('title');
          link = item.getChild('link').getAttribute('href').getValue();
          description = item.getChildText('summary') || '';
          imageUrl = "https://via.placeholder.com/800x400?text=" + encodeURIComponent(title);
        } else { // RSS 2.0
          title = item.getChildText('title');
          link = item.getChildText('link');
          description = item.getChildText('description') || '';
          let content = item.getChildText('content:encoded') || description;
          let match = content.match(/<img[^>]+src="([^">]+)"/i);
          imageUrl = match ? match[1] : "https://via.placeholder.com/800x400?text=" + encodeURIComponent(title);
        }

        if (!link) continue;
        if (isAlreadyPosted(link)) {
          Logger.log(`⏩ Sudah pernah dipost: ${title}`);
          continue;
        }

        // === Generate artikel panjang + gambar ===
        const content = generateSEOArticle(title, description, imageUrl);

        postToBlogger(title, content);
        storePostedLink(title, link);
        Logger.log(`✅ Draft artikel SEO berhasil dibuat: ${title}`);
        break; // hanya ambil 1 artikel per feed
      }
    } catch (e) {
      Logger.log(`❌ Error RSS ${rssUrl}: ${e.message}`);
    }
  }
}
